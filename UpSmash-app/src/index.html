<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div id ="logo">
      <img id="upSmashLogo" src="../../UpSmash/static/images/UpSmash-02-purple.jpg" alt="UpSmash Logo">
      <div id = "content">
        <label>Specify Slippi Files (.slp) path, can typically be found at C:Users/'username'/Documents/Slippi/: </label>
          <input type="file" id="slpFolder" name="fileList" webkitdirectory multiple/>
          <ul id="listing"></ul>
      </div>
    </div>
    <script>
      const electron = require('electron');
      const { ipcRenderer } = electron;
      const { SlippiGame } = require("@slippi/slippi-js");
      const { request } = require('http');

      // function for getting a list of players games
      async function games_played(connect_code) {
        const game_options = {
          hostname:'localhost',
          port: '5000',
          path: '/player_games/' + connect_code.replace('#','-'),
          method: 'GET'
        };
        let response = await doRequest(game_options, connect_code)
        return response
      }
      function doRequest(url, connect_code) {
        return new Promise(function (resolve, rejest) {
          const req = request(url, (response) => {
            response.setEncoding('utf8');
            console.log(response.statusCode);
            var body = '';
            // catches the servers response and prints it
            response.on('data', (game_list) => {
              body += game_list
            });
            // if the response is over, writes it also
            response.on('end', function() {
              if (response.statusCode == 200) {
                resolve(body)
              }
            });
          });
        // error processing
          req.on('error', (err) => {
            console.log(response.statusCode);
            reject(err);
          });
          // send the actual data
          req.write(connect_code);
          req.end();
        })
      };

      // listens for a click change
      document.getElementById("slpFolder").addEventListener("change", (event) => {
        // variables to write to in the display in order to tell the user how many files have been uploaded
        let output = document.getElementById("listing");
        let item = document.createElement("li");
        // this is the directory where the files are
        let parent = event.target.files[0].path;
        let sub = parent.split('\\');
        let removed = sub.pop();
        var connect_local;
        // just removing some of the stuff so we can append the filename at the end and get an absolute path
        let final = '';
        // adds the file names to the list, after loop will have the full list of files names to upload
        for (const subs of sub) {
          if (final === '') {
            final = final + subs
          } else{
            final = final + '/' + subs;
          }
        };
        item.textContent = final;
        output.appendChild(item);
        let fileList = new Array();
        let fileSub = new Array();
        for (const file of event.target.files) {
          fileList.push(file.path);
          if (file.path.split('.')[file.path.split('.').length - 1] == 'slp') {
            parent = file.path.split('.')[0, file.path.split('.').length - 2];
            sub = parent.split('\\')[parent.split('\\').length - 1];
            fileSub.push(sub)
          };
        };
        if (fileList.length > 1){
          let g1 = new SlippiGame(fileList[0]);
          let g2 = new SlippiGame(fileList[1]);
          let g1_meta = g1.getMetadata();
          let g2_meta = g2.getMetadata();
          let g1_connect = [g1_meta['players'][0]['names']['code'], g1_meta['players'][1]['names']['code']]
          console.log(g1_connect)
          let g2_connect = [g2_meta['players'][0]['names']['code'], g1_meta['players'][1]['names']['code']]
          console.log(g2_connect)
          connect_local = g1_connect.filter(value => g2_connect.includes(value))

        } else if (fileList.length == 1) {
          let g1 = new SlippiGame(fileList[0]);
          let g1_meta = g1.getMetaData();
          connect_local = g1_meta['players'][0]['names']['code']
        }
        console.log(connect_local[0])
        let game_list = games_played(connect_local[0]);

        game_list.then((value) => {
          console.log(fileSub)
          let to_send = fileSub.filter(function(item) {
            console.log(value)
            return value.indexOf(item) == -1;
          });
          console.log(to_send)
          if (fileList.length ==  event.target.files.length) {
            ipcRenderer.send("fileList", to_send)
            ipcRenderer.send("parentPath", final)
          }; 
        }) 
      }, false);
    </script>
  </body>
</html>
